<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>OL-deltagande</title>
	<link href="lib/css/bootstrap-icons.css" rel="stylesheet">
	<link href="lib/css/bootstrap_4.4.1_css_bootstrap.min.css" rel="stylesheet">
	<link href="lib/css/style.css" rel="stylesheet">
	<link rel="icon" href="lib/img/favicon.svg">
	<link rel="apple-touch-icon" href="lib/img/favicon.ico">
	<script src="lib/js/jquery-3.6.0.min.js" charset="UTF-8"></script>
</head>
<body>

	<nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #3f9049;">
		<a class="navbar-brand">SFK OL</a>
		<button class="navbar-toggler text-white" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon text-white"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav">
				<li class="nav-item active" id="overviewNav">
					<a class="nav-link" onclick="showOverview();return false;">Närvaro</a>
				</li>
				<li class="nav-item" id="settingsNav">
					<a class="nav-link" onclick="showSettings();return false;">Inställningar</a>
				</li>
			</ul>
		</div>
	</nav>

	<script type="text/template" id="personsChecklistTemplate">
		<% 
		var persons = data.persons;
		/* var hide = document.getElementById("hideCompleted").checked; */
		_.forEach(persons, function(person) { 
			%><tr class="runner" data-hidden="adad" data-here-status="<%= person.status ? person.status:'unknown' %>"  data-run-status="<%= person.run ? person.run:'unknown' %>">
				<td class="name"><span><%= person.name %></span><small class="text-muted d-block-lg ml-1"><%= person.class %></small></td>
				<td class="status text-center" style="cursor: pointer;" onclick="changePersonStatus($(this).parent());"><%= getPersonStatusIcon(person.status) %></td>
				<td class="run text-center<%= person.status == 'nothere' ? ' disabled':'' %>" style="cursor: pointer;" onclick="changeRunStatus($(this).parent());"><%= getRunStatusIcon(person.run) %></td>
			</tr>
		<% }); %>
	</script>

	<script type="text/template" id="personStatsTemplate">
		<div class="list-group w-100 shadow-sm">
			<div class="list-group-item p-2 d-flex bg-light"><i class="bi-tree-fill text-success mr-1"></i>Kvar ute i skogen: <span class="ml-auto"><%= out %> st<%= out == "0"?"<i class='bi-check text-success ml-1'></i>":"" %></span></div>
			<div class="list-group-item p-2 d-flex bg-light"><i class="bi-person-check-fill text-success mr-1"></i>Närvarande: <span class="ml-auto"><%= here %> st (<%= unknown %> st okända)</span></div>
			<div class="list-group-item p-2 d-flex bg-light"><i class="bi-person-x-fill text-danger mr-1"></i>Frånvarande: <span class="ml-auto"><%= nothere %> st</span></div>
		</div>
	</script>

	<div id="overviewContainer" style="display: none;">

		<table class="table table-sm table-striped table-dark mb-1" id="overviewTable">
		<thead class="thead-dark">
			<tr>
				<th scope="col">Namn</th>
				<th class="text-center">Här</th>
				<th class="text-center">Ute/Mål</th>
			</tr>
		</thead>
		<tbody id="personsChecklist"></tbody>
		</table>

		<div id="startInfo" class="row ml-4 d-none">Lägg till personer under <a href="#" onclick="showSettings();return false;">Inställningar</a> i menyn.</div>
		<div class="row m-2" id="personStats"></div>
		<div class="row m-2">
			<p class="m-2">Till <a href="#" onclick="showSettings();return false;">Inställningar &raquo;</a></p>
		</div>
		<div class="row d-flex flex-row-reverse align-items-center m-2">
			<button type="button" class="btn btn-primary mr-4" id="share" onclick="shareData();">Dela...</button>
			<button type="button" class="btn btn-primary mr-4" id="report" onclick="createReport();">Rapport</button>
			<div class="custom-control custom-switch mt-2 mr-4 d-none" onclick="hideCompleted();">
				<input type="checkbox" class="custom-control-input" id="hideCompleted">
				<label class="custom-control-label" for="hideCompleted">Dölj klara</label>
			</div>
			<small id="reportMessage" class="text-muted invisible mr-2">Närvarande personer har kopierats till urklipp - så du kan nu klistra in det i ett meddelande, mejl etc.</small>
		</div>
		<div class="row">
			<textarea class="invisible text-muted ml-4 mr-4 mb-8 w-100" id="createReport"></textarea>
		</div>

	</div>

	<!-- Modal for sharing -->
	<div class="modal" tabindex="-1" id="shareModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Dela</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Kopiera länken och dela (via SMS, Slack, e-post)</p>
					<p id="shareLink"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="shareModal.hide();">Stäng</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal for adding list of persons -->
	<div class="modal" tabindex="-1" id="addListModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Lägg till personer</h5>
				</div>
				<div class="modal-body">
					<div id="names">
						<div class="input-group">
							<textarea id="personData" class="form-control noscrollbars" aria-label="Personer" placeholder="Namn;Klass"></textarea>
							<!-- <textarea id="personData" class="form-control noscrollbars" aria-label="Personer" placeholder="Namn;Klass" onkeyup="autoGrow(this);"></textarea> -->
						</div>
					</div>
					<small class="form-text text-muted">En person per rad. Lägg till semikolon (;) för att ange eventuell klass/notering (Ex: "Leif Andersson;Gul")</small>
					<div id="debugAdd"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="addList();">Lägg till</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="addListModal.hide();">Avbryt</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal for report -->
	<div class="modal" tabindex="-1" id="reportModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Närvarande idag</h5>
				</div>
				<div class="modal-body">
					<div id="reportedHere"></div>
					<small class="form-text text-muted">Registrera i <a href="https://orientering.sjovalla.se" target="_blank">Idrott Online</a> (enklast med dator). Samma inloggning som Eventor</small>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="reportModal.hide();">Stäng</button>
				</div>
			</div>
		</div>
	</div>

	<div id="settingsContainer" class="p-2" style="display: none;">
		<!--<div id="classes">
			<div class="input-group">
				<div class="input-group-prepend">
					<span class="input-group-text">Banor</span>
				</div>
				<textarea id="banorData" class="form-control" aria-label="Banor"></textarea>
			</div>
		</div>-->
		<h5 class="my-2">Inställningar</h5>
		<div class="custom-control custom-switch mt-2 d-none">
			<input type="checkbox" class="custom-control-input" id="settingsDetails">
			<label class="custom-control-label" for="settingsDetails">Visa klasser</label>
		</div>
		<div class="custom-control custom-switch mt-2">
			<input type="checkbox" class="custom-control-input" id="settingsLargeTable">
			<label class="custom-control-label" for="settingsLargeTable">Visa liten tabell</label>
		</div>

		<h5 class="my-2">Personer att hantera</h5>
		<div class="row pl-2">
			<button type="button" class="btn btn-sm btn-primary m-2" id="addList" onclick="addListModal.show();">Lägg till...</button>
			<p class="m-2">Till <a href="" onclick="showOverview();return false;">Närvaro &raquo;</a></p>
		</div>
		<div class="row px-2">
			<div class="m-2" id="personsList"><p class="ml-2">Inga personer inlagda</p></div>
		</div>

		<script type="text/template" id="personListTemplate">
			<ul class="list-group shadow-sm">
				<% _.forEach(persons, function(person) { %>
					<li class="list-group-item d-flex align-items-center p-2 bg-light">
						<span><%= person.name %></span>
						<span class="small text-muted ml-1"><%= person.class %></span>
						<a class="text-danger ml-auto" href="javascript:deletePerson('<%= person.name %>');">Ta bort</a>
					</li>
				<% }); %>
			</ul>
		</script>

		<h5 class="my-2">För att hämta från Eventor</h5>
		<ul class="list-group shadow-sm">
			<!--<li class="list-group-item">Klicka på <a href="javascript:getEventorPersons();">mig</a></li>-->
			<li class="list-group-item p-2 bg-light">1. Förutsättning: Se till att ha följande länk <a href="javascript:(function(){var s='';document.querySelectorAll('#main%20h3%20~%20table%20tbody%20tr:nth-child(1n+1)%20td:nth-child(-n+2)').forEach((tds,idx)=>{if(idx%2==0){s+=tds.innerHTML+';'}else{s+=tds.innerHTML+'\n'}});var%20node=document.createElement('textarea');node.id='tmpExtra';node.value=s;node.innerText=s;var%20targetNode=document.getElementById('main');var%20config={attributes:false,childList:true,subtree:true};var%20callback=function(mutationsList,observer){for(let%20mutation%20of%20mutationsList){if(mutation.type==='childList'){var%20node=document.getElementById('tmpExtra');node.select();document.execCommand('copy');console.log('Attendances%20copied%20into%20clipboard');observer.disconnect()}}};const%20observer=new%20MutationObserver(callback);observer.observe(targetNode,config);document.querySelector('#main').appendChild(node);alert('De anmälda är kopierade. Gå tillbaka till närvarosidan och klistra in!');})();">länk</a> som ett bokmärke</li>
			<li class="list-group-item p-2 bg-light">2. Gå till önskad aktivitet i <a href="https://eventor.orientering.se/Activities?organisationId=321" target="_blank">Eventor</a></li>
			<li class="list-group-item p-2 bg-light">3. Klicka på bokmärket (som kopierar de anmälda i rätt format åt dig)</li>
			<li class="list-group-item p-2 bg-light">4. Välj <span class="badge badge-primary btn" onclick="addListModal.show();">Lägg till..</span> och klistra in</li>
		</ul>
		<div class="row pl-2">
			<p class="m-2" id="version"></p>
		</div>

		<!--<small class="form-text text-muted">En person per rad. Förändring i textrutan ovan rensar alla ifylld händelser i närvaroöversikten! Lägg till ev. övriga personer nedan istället.</small>-->
		<!--<div class="row d-flex flex-row-reverse p-2">
			<button type="button" class="btn btn-primary mr-2">Spara</button>
			<button type="button" class="btn btn-secondary mr-2">Avbryt</button>
		</div>-->


		<!--<textarea id="debugPersonData" class="form-control mt-5" readonly></textarea>-->

		<!--<h5 class="my-2">Lägg till person</h5>
		<div id="addPerson">
			<div class="input-group">
				<textarea id="personData" class="form-control" aria-label="Person" ></textarea>
			</div>
		</div>-->
	</div>

	<script src="lib/js/bootstrap.4.4.1.min.js"></script>
	<script src="lib/js/purify.min.js"></script>
	<script src="lib/js/lz-string.js"></script>
	<script src="lib/js/moment.js"></script>
	<script src="lib/js/locale/sv.js" charset="UTF-8"></script>
	<script src="lib/js/lodash.min.js"></script>
	<script src="lib/js/svg-icons.js" charset="UTF-8"></script>
	<script src="lib/js/app.js" charset="UTF-8"></script>
	<script>
		$( document ).ready(function() {
			console.log("Ready!");
			
			// Init
			var params = new URLSearchParams(document.location.search);
			var save = false;
			if (params.has("data")) {
				/*let hide = localStorage.getItem("ol-hide");
				if(hide) {
					document.getElementById("hideCompleted").checked = "checked";
				} else {
					document.getElementById("hideCompleted").checked = "";
				}*/

				if (document.location.hash!="#imported") {
					// Data to import
					console.log("Try to import data");
					localStorage.setItem("ol-state", VIEWS.OVERVIEW);
					importData();
					save = true;
				} else {
					console.log("Data already imported");
					var personsLoaded = getDataFromLocalStorage();
					appdata.persons = personsLoaded || [];
				}
			} else {
				var personsLoaded = getDataFromLocalStorage();
				appdata.persons = personsLoaded || [];
				console.log("No data to import");
			}

			document.getElementById("version").innerHTML = ("Version: " + version);

			var view = localStorage.getItem("ol-state");
			if(view == VIEWS.SETTINGS) {
				showSettings();
			} else {
				showOverview();
				if(save) {
					// Must save imported data
					saveCheckData();
					console.log("data saved first time")
				}

			}
			updatePersonStats();
		
			//state.loadAndShowState();
		
			//document.getElementById("export").innerHTML = exportIcon + "Exportera"
		
			//window.onbeforeunload = function() {
			//	return "Om du laddar om kommer inmatad data försvinna!";
			//}
		
		});
	</script>
</body>
</html>