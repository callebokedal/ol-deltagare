<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>OL-deltagande</title>
	<link href="lib/css/bootstrap_4.4.1_css_bootstrap.min.css" rel="stylesheet">
	<link href="lib/css/style.css" rel="stylesheet">
	<link rel="icon" href="lib/img/favicon.svg">
	<!--<link rel="icon" href="lib/img/favicon.ico">-->
	<link rel="apple-touch-icon" href="lib/img/favicon.ico">
	<script src="lib/js/jquery-3.6.0.min.js" charset="UTF-8"></script>
</head>
<body>

	<nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #3f9049;">
		<a class="navbar-brand">SFK OL</a>
		<button class="navbar-toggler text-white" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon text-white"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav">
				<li class="nav-item active" id="overviewNav">
					<a class="nav-link" onclick="showOverview();return false;">Närvaro</a>
				</li>
				<li class="nav-item" id="settingsNav">
					<a class="nav-link" onclick="showSettings();return false;">Inställningar</a>
				</li>
			</ul>
		</div>
	</nav>

	<script type="text/template" id="personsChecklistTemplate">
		<% 
		var persons = data.persons;
		_.forEach(persons, function(person) { 
		%><tr class="runner" data-here-status="<%= person.status ? person.status:'unknown' %>" data-run-status="<%= person.run ? person.run:'unknown' %>">
			<td class="name"><span><%= person.name %></span><%= data.showClasses ? '<small class="text-muted d-block-lg ml-1">'+ person.class +'</small>': '' %></td>
			<td class="status text-center" style="cursor: pointer;" onclick="changePersonStatus($(this).parent());"><%= getPersonStatusIcon(person.status) %></td>
			<td class="run text-center<%= person.status == "nothere" ? ' disabled':'' %>" style="cursor: pointer;" onclick="changeRunStatus($(this).parent());"><%= getRunStatusIcon(person.run) %></td>
		</tr>
		<% }); %>
	</script>

	<div id="overviewContainer" style="display: none;">

		<table class="table table-sm table-striped table-dark" id="overviewTable">
		<thead class="thead-dark">
			<tr>
				<th scope="col">Namn</th>
				<th class="text-center">Här</th>
				<th class="text-center">Ute/Mål</th>
			</tr>
		</thead>
		<tbody id="personsChecklist"></tbody>
		</table>

		<div id="startInfo" class="ml-4 d-none">Lägg till personer under <a href="#" onclick="showSettings();return false;">Inställningar</a> i menyn.</div>
		<div id="personStats" class="ml-4"></div>

		<div class="row d-flex flex-row-reverse align-items-center p-2">
			<button type="button" class="btn btn-primary mr-4" id="share" onclick="shareData();">Dela...</button>
			<button type="button" class="btn btn-primary mr-4" id="report" onclick="createReport();">Skapa rapport</button>
			<small id="reportMessage" class="text-muted invisible mr-2">Närvarande personer har kopierats till urklipp - så du kan nu klistra in det i ett meddelande, mejl etc.</small>
		</div>
		<div class="row">
			<textarea class="invisible text-muted ml-4 mr-4 mb-8 w-100" id="createReport"></textarea>
		</div>
		<div class="row p-4">
			<p class="m-2">Till <a href="#" onclick="showSettings();return false;">Inställningar</a></p>
		</div>

	</div>

	<!-- Modal for sharing -->
	<div class="modal" tabindex="-1" id="shareModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Dela</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Kopiera länken och dela (via SMS, Slack, e-post)</p>
					<p id="shareLink"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="shareModal.hide();">Stäng</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal for adding list of persons -->
	<div class="modal" tabindex="-1" id="addListModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Lägg till personer</h5>
				</div>
				<div class="modal-body">
					<div id="names">
						<div class="input-group">
							<textarea id="personData" class="form-control noscrollbars" aria-label="Personer" placeholder="Namn;Klass"></textarea>
							<!-- <textarea id="personData" class="form-control noscrollbars" aria-label="Personer" placeholder="Namn;Klass" onkeyup="autoGrow(this);"></textarea> -->
						</div>
					</div>
					<small class="form-text text-muted">En person per rad. Lägg till semikolon (;) för att ange eventuell klass/notering (Ex: "Leif Andersson;Gul")</small>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="addList();">Lägg till</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="addListModal.hide();">Avbryt</button>
				</div>
			</div>
		</div>
	</div>

	<div id="settingsContainer" class="p-2" style="display: none;">
		<!--<div id="classes">
			<div class="input-group">
				<div class="input-group-prepend">
					<span class="input-group-text">Banor</span>
				</div>
				<textarea id="banorData" class="form-control" aria-label="Banor"></textarea>
			</div>
		</div>-->
		<h5 class="my-2">Inställningar</h5>
		<div class="custom-control custom-switch mt-2">
			<input type="checkbox" class="custom-control-input" id="settingsDetails">
			<label class="custom-control-label" for="settingsDetails">Visa klasser</label>
		</div>
		<div class="custom-control custom-switch mt-2">
			<input type="checkbox" class="custom-control-input" id="settingsLargeTable">
			<label class="custom-control-label" for="settingsLargeTable">Visa liten tabell</label>
		</div>

		<h5 class="my-2">Personer att hantera</h5>
		<div class="row pl-2">
			<button type="button" class="btn btn-sm btn-primary m-2" id="addList" onclick="addListModal.show();">Lägg till...</button>
		</div>
		<div class="row pl-2">
			<p class="m-2" id="personsList">Inga personer inlagda</p>
		</div>

		<script type="text/template" id="personListTemplate">
			<% _.forEach(persons, function(person) { %>
			<div>
				<div><%= person.name %> <span class="small"><%= person.class %></span> <a href="javascript:deletePerson('<%= person.name %>');">Ta bort<a></div>
			</div>
			<% }); %>
		</script>

		<h5 class="my-2">För att hämta från Eventor</h5>
		<ul class="list-group">
			<!--<li class="list-group-item">Klicka på <a href="javascript:getEventorPersons();">mig</a></li>-->
			<li class="list-group-item">1. Förutsättning: Se till att ha följande länk <a href="javascript:(function(){var s='';document.querySelectorAll('#main%20h3%20~%20table%20tbody%20tr:nth-child(1n+1)%20td:nth-child(-n+2)').forEach((tds,idx)=>{if(idx%2==0){s+=tds.innerHTML+';'}else{s+=tds.innerHTML+'\n'}});var%20node=document.createElement('textarea');node.id='tmpExtra';node.value=s;node.innerText=s;var%20targetNode=document.getElementById('main');var%20config={attributes:false,childList:true,subtree:true};var%20callback=function(mutationsList,observer){for(let%20mutation%20of%20mutationsList){if(mutation.type==='childList'){var%20node=document.getElementById('tmpExtra');node.select();document.execCommand('copy');console.log('Attendances%20copied%20into%20clipboard');observer.disconnect()}}};const%20observer=new%20MutationObserver(callback);observer.observe(targetNode,config);document.querySelector('#main').appendChild(node);alert('De anmälda är kopierade. Gå tillbaka till närvarosidan och klistra in!');})();">länk</a> som ett bokmärke</li>
			<li class="list-group-item">2. Gå till önskad aktivitet i <a href="https://eventor.orientering.se/Activities?organisationId=321" target="_blank">Eventor</a></li>
			<li class="list-group-item">3. Klicka på bokmärket (som kopierar de anmälda i rätt format åt dig)</li>
			<li class="list-group-item">4. Välj <span class="badge badge-primary btn" onclick="addListModal.show();">Lägg till..</span> och klistra in</li>
		  </ul>
		<div class="row pl-2">
			<p class="m-2"></p>
		</div>
		<div class="row pl-2">
			<p class="m-2">Till <a href="" onclick="showOverview();return false;">Närvaro</a></p>
		</div>

		<!--<small class="form-text text-muted">En person per rad. Förändring i textrutan ovan rensar alla ifylld händelser i närvaroöversikten! Lägg till ev. övriga personer nedan istället.</small>-->
		<!--<div class="row d-flex flex-row-reverse p-2">
			<button type="button" class="btn btn-primary mr-2">Spara</button>
			<button type="button" class="btn btn-secondary mr-2">Avbryt</button>
		</div>-->


		<!--<textarea id="debugPersonData" class="form-control mt-5" readonly></textarea>-->

		<!--<h5 class="my-2">Lägg till person</h5>
		<div id="addPerson">
			<div class="input-group">
				<textarea id="personData" class="form-control" aria-label="Person" ></textarea>
			</div>
		</div>-->
	</div>

	<script src="lib/js/bootstrap.4.4.1.min.js"></script>
	<script src="lib/js/purify.min.js"></script>
	<script src="lib/js/moment.js"></script>
	<script src="lib/js/locale/sv.js" charset="UTF-8"></script>
	<script src="lib/js/lodash.min.js"></script>
	<script src="lib/js/svg-icons.js" charset="UTF-8"></script>
	<script src="lib/js/app.js" charset="UTF-8"></script>
	<script>
		$( document ).ready(function() {
			console.log("Ready!");
			
			// Init
			var params = new URLSearchParams(document.location.search);
			if (params.has("data")) {
				if (document.location.hash!="#imported") {
					// Data to import
					console.log("Try to import data")
					importData();
				} else {
					console.log("Data already imported")
				}
			} else {
				console.log("No data to import")
			}

			var view = localStorage.getItem("ol-state");
			var personsLoaded = getDataFromLocalStorage();
			appdata.persons = personsLoaded;
			if(view == VIEWS.SETTINGS) {
				showSettings();
			} else {
				showOverview();
			}
		
			//state.loadAndShowState();
		
			//document.getElementById("export").innerHTML = exportIcon + "Exportera"
		
			//window.onbeforeunload = function() {
			//	return "Om du laddar om kommer inmatad data försvinna!";
			//}
		
		});
	</script>
</body>
</html>